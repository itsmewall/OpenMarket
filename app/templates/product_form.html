{% extends "base.html" %}
{% block title %}{{ 'Editar produto' if product else 'Novo produto' }}{% endblock %}

{% block content %}
<h1>{{ 'Editar produto' if product else 'Cadastrar produto' }}</h1>

<form class="form" method="post"
      action="{{ url_for('products.edit', pid=product.id) if product else url_for('products.new_post') }}">
  {{ form.hidden_tag() }}

  <div class="card">
    <div class="grid2">
      <div class="field">
        {{ form.nome.label }} {{ form.nome(class="input", placeholder="Ex.: Arroz Tipo 1 5 kg") }}
        {% for e in form.nome.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        {{ form.categoria_id.label }} {{ form.categoria_id(class="input") }}
        {% for e in form.categoria_id.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        {{ form.sku.label }} {{ form.sku(class="input", placeholder="Se quiser controlar seu código") }}
        {% for e in form.sku.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        {{ form.ean.label }} {{ form.ean(class="input", placeholder="Só números. Deixe vazio se não tiver") }}
        {% for e in form.ean.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid3">
      <div class="field">
        {{ form.custo_atual.label }} {{ form.custo_atual(class="input", step="0.01", id="custo") }}
        {% for e in form.custo_atual.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        {{ form.preco_venda.label }} {{ form.preco_venda(class="input", step="0.01", id="preco") }}
        {% for e in form.preco_venda.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        <label>Lucro estimado</label>
        <input class="input" id="lucro_view" type="text" readonly value="0,00 %">
      </div>

      <div class="field">
        {{ form.estoque_minimo.label }} {{ form.estoque_minimo(class="input", step="0.0001", placeholder="Ex.: 2") }}
        {% for e in form.estoque_minimo.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        {{ form.ponto_pedido.label }} {{ form.ponto_pedido(class="input", step="0.0001", placeholder="Ex.: 4") }}
        {% for e in form.ponto_pedido.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        <label class="check-inline">{{ form.ativo() }} <span>Produto ativo</span></label>
        {% for e in form.ativo.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid2">
      <div class="field">
        {{ form.foto_url.label }} {{ form.foto_url(class="input", placeholder="https://link-da-foto") }}
        {% for e in form.foto_url.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        <label>Pré-visualização</label>
        <div style="border:1px solid var(--bd); padding:6px; border-radius:8px; height:120px; display:grid; place-items:center;">
          <img id="imgPreview" src="{{ form.foto_url.data or '' }}" alt="" style="max-height:108px" onerror="this.src=''">
        </div>
      </div>
    </div>
  </div>

  <details class="card">
    <summary style="padding:12px 16px; cursor:pointer; font-weight:700">Campos fiscais (opcional)</summary>
    <div style="padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
      <div class="field">
        {{ form.unidade.label }} {{ form.unidade(class="input") }}
        {% for e in form.unidade.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        {{ form.ncm.label }} {{ form.ncm(class="input") }}
        {% for e in form.ncm.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        {{ form.cest.label }} {{ form.cest(class="input") }}
        {% for e in form.cest.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="field">
        {{ form.margem_alvo.label }} {{ form.margem_alvo(class="input", step="0.01") }}
        {% for e in form.margem_alvo.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
    </div>
  </details>

  <div class="row" style="gap:10px; margin-top:12px;">
    <a class="btn" href="{{ url_for('products.list_') }}">Cancelar</a>
    <button class="btn primary" type="submit">{{ 'Salvar alterações' if product else 'Cadastrar' }}</button>
  </div>
</form>

<script>
(function(){
  function val(id){ const el=document.getElementById(id); if(!el) return 0; const v=(el.value||'').replace(',','.'); const n=parseFloat(v); return isFinite(n)?n:0; }
  function pct(n){ return (n||0).toFixed(2).replace('.',',') + ' %'; }
  function upd(){ const c=val('custo'), p=val('preco'); const m=(p>0)?((p-c)/p*100):0; document.getElementById('lucro_view').value=pct(m); }
  ['custo','preco'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', upd); }});
  const foto=document.querySelector('input[name="foto_url"]'); if(foto){ foto.addEventListener('input', ()=>{ const img=document.getElementById('imgPreview'); if(img) img.src=foto.value||''; });}
  upd();
})();
</script>
{% endblock %}
